{% extends "admin/base_site.html" %} {% load i18n static %} {% block content %}
<div id="content-main">
  <div class="module" style="margin-bottom: 20px">
    <strong>Filter by Financial Year: </strong>
    <a
      href="?"
      style="margin-right: 10px; {% if not selected_fy %}font-weight: bold; text-decoration: none; color: black;{% endif %}"
      >All</a
    >
    {% for fy in all_fys %}
    <a
      href="?fy={{ fy }}"
      style="margin-right: 10px; {% if selected_fy == fy %}font-weight: bold; text-decoration: none; color: black;{% endif %}"
      >{{ fy }}</a
    >
    {% endfor %}
  </div>

  <div class="module" style="margin-bottom: 30px">
    <h2>Grand Totals {% if selected_fy %}({{ selected_fy }}){% endif %}</h2>
    <table style="width: 100%; border-collapse: collapse; max-width: 600px">
      <thead>
        <tr style="background: #e1e1e1; text-align: left">
          <th style="padding: 10px; border-bottom: 2px solid #ccc">
            Financial Year
          </th>
          <th style="padding: 10px; border-bottom: 2px solid #ccc">
            Grand Total (HKD)
          </th>
        </tr>
      </thead>
      <tbody>
        {% for item in fy_summary_list %}
        <tr>
          <td style="padding: 10px; border-bottom: 1px solid #ddd">
            <strong>{{ item.fy }}</strong>
          </td>
          <td style="padding: 10px; border-bottom: 1px solid #ddd">
            <strong>{{ item.total|floatformat:2 }}</strong>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="2" style="padding: 10px">No donations recorded yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h2>Details per User</h2>
  <div class="module">
    <table style="width: 100%; border-collapse: collapse">
      <thead>
        <tr style="background: #f8f8f8; text-align: left">
          <th style="padding: 10px; border-bottom: 1px solid #ddd">User</th>
          <th style="padding: 10px; border-bottom: 1px solid #ddd">
            Financial Year
          </th>
          <th style="padding: 10px; border-bottom: 1px solid #ddd">
            Total Amount (HKD)
          </th>
        </tr>
      </thead>
      <tbody>
        {% for item in summary_list %}
        <!-- Main Row -->
        <tr
          class="summary-row"
          onclick="toggleDetails('details-{{ forloop.counter }}')"
          style="cursor: pointer"
        >
          <td style="padding: 10px; border-bottom: 1px solid #eee">
            <span style="font-weight: bold; color: #447e9b">â–¸</span>
            {{ item.user.username }} {% if item.user.get_full_name %} ({{
            item.user.get_full_name }}) {% endif %}
          </td>
          <td style="padding: 10px; border-bottom: 1px solid #eee">
            {{ item.fy }}
          </td>
          <td style="padding: 10px; border-bottom: 1px solid #eee">
            <strong>{{ item.total|floatformat:2 }}</strong>
          </td>
        </tr>

        <!-- Detail Row (Hidden by default) -->
        <tr id="details-{{ forloop.counter }}" style="display: none">
          <td colspan="3" style="padding: 0">
            <div style="padding: 10px 20px; border-bottom: 1px solid #eee">
              <table
                style="
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 0.9em;
                  border: 1px solid #eee;
                "
              >
                <thead>
                  <tr style="background: #efefef">
                    <th style="padding: 6px; border-bottom: 1px solid #ddd">
                      Date
                    </th>
                    <th style="padding: 6px; border-bottom: 1px solid #ddd">
                      Amount
                    </th>
                    <th style="padding: 6px; border-bottom: 1px solid #ddd">
                      Notes
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for don in item.donations %}
                  <tr>
                    <td style="padding: 6px; border-bottom: 1px solid #eee">
                      {{ don.date|date:"Y-m-d" }}
                    </td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee">
                      {{ don.amount|floatformat:2 }}
                    </td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee">
                      {{ don.notes|default:"-" }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" style="padding: 20px; text-align: center">
            No donations found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  function toggleDetails(rowId) {
    var row = document.getElementById(rowId);
    if (row.style.display === "none") {
      row.style.display = "table-row";
    } else {
      row.style.display = "none";
    }
  }
</script>
{% endblock %}
